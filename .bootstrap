#!/usr/bin/env sh

set errexit  # Exit on error.
set nounset  # Error on undeclared variables.
set pipefail # Error if any command in a pipe fails.

REPO_URL_SSH=git@github.com:murar8/dotfiles.git
REPO_URL_HTTPS=https://github.com/murar8/dotfiles.git

REPO_DIR=$HOME/.dotfiles
SCRIPT_DIR=$(cd -P -- "$(dirname -- "$(command -v -- "$0")")" && pwd -P)

if [ -d "$REPO_DIR" ]; then
    echo "$REPO_DIR already exists, exiting."
    exit 0
fi

if ! command -v git >/dev/null; then
    echo "Error: could not locate git in your path."
    exit 1
fi

USE_SSH=true
if ! command -v ssh >/dev/null; then
    echo "Warning: could not locate ssh in your path, falling back to HTTPS."
    echo
    USE_SSH=false
fi
if ! ssh-add -l >/dev/null 2>&1; then
    echo "Warning: could not find any SSH keys in your ssh-agent, falling back to HTTPS."
    echo
    USE_SSH=false
fi

dot() {
    # shellcheck disable=SC2068
    git --git-dir="$REPO_DIR" -C "$HOME" --work-tree="$HOME" $@
}

if $USE_SSH; then
    # This is to avoid ssh prompting for confirmation when cloning.
    if [ ! -f "$HOME"/.ssh/known_hosts ]; then
        echo "Creating $HOME/.ssh/known_hosts..."
        mkdir -p "$HOME"/.ssh
        touch "$HOME"/.ssh/known_hosts
        chmod 600 "$HOME"/.ssh/known_hosts
        echo
    fi
    if ! ssh-keygen -F github.com >/dev/null; then
        echo "Adding github.com to known hosts..."
        ssh-keyscan -t rsa github.com >>"$HOME"/.ssh/known_hosts
        echo
    fi
fi

if $USE_SSH; then
    REPO_URL=$REPO_URL_SSH
else
    REPO_URL=$REPO_URL_HTTPS
fi

# Most providers (e.g. GitHub) will not allow you to clone into a bare
# repository directly, so we clone into a temporary directory and then convert
# it to a bare repository.
if [ -d "$SCRIPT_DIR/.git" ]; then
    echo "Non bare repository detected in $SCRIPT_DIR, copying from local..."
    git clone --bare "$SCRIPT_DIR" "$REPO_DIR"
    echo
    echo "Removing $SCRIPT_DIR..."
    rm -rf "$SCRIPT_DIR"
    echo
else
    git clone --bare "$REPO_URL" "$REPO_DIR"
    echo
fi

if [ -n "$(dot status --porcelain)" ]; then
    stash_name="bootstrap-$(date +%s)"
    user=$(whoami)
    echo "Stashing conflicts in $stash_name..."
    dot -c user.name="$user" -c user.email="$user"@localhost stash save "$stash_name"
    echo
fi

dot config status.showUntrackedFiles no
dot config remote.origin.url "$REPO_URL"
dot config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'

echo "Fetching origin..."
dot pull origin main
echo
dot branch --set-upstream-to=origin/main main
echo

if [ "$REMOTE_CONTAINERS" = true ]; then
    if ! command -v jq >/dev/null; then
        echo "Warning: jq not found in your path, skipping neovim installation."
    elif command -v nvim >/dev/null; then
        echo "Neovim is already installed, skipping."
    elif [ "$(arch)" != "x86_64" ]; then
        echo "Running in a remote container, but not on x86_64, skipping neovim installation."
    else
        echo "Running in a remote container, installing neovim..."
        echo
        curl -fsSL https://api.github.com/repos/neovim/neovim/releases/latest |
            jq -r '.assets[] | select(.name | endswith("linux64.tar.gz")) | .browser_download_url' |
            xargs curl -fsSL |
            sudo tar xzf - -C /usr/local --strip-components=1
        echo
    fi
fi

echo "All done!"
