#!/usr/bin/env bash

set -o errexit  # Exit on error.
set -o nounset  # Error on undeclared variables.
set -o pipefail # Error if any command in a pipe fails.

REPO_DIR="$HOME/.dotfiles"

dot() {
    git --git-dir="$REPO_DIR" --work-tree="$HOME" "$@"
}

if [ -d "$REPO_DIR" ]; then
    echo "Looks like your environment is already bootstrapped."
    exit 0
fi

if ! command -v git >/dev/null; then
    echo "Error: could not locate git in your path."
    exit 1
fi

REPO_URL=https://github.com/murar8/dotfiles.git
if ! command -v ssh >/dev/null; then
    echo "Warning: could not locate ssh in your path, falling back to HTTPS."
    echo
elif ! ssh-add -l >/dev/null 2>&1; then
    echo "Warning: no usable SSH keys available, falling back to HTTPS."
    echo
else
    REPO_URL=git@github.com:murar8/dotfiles.git
    # This is to avoid ssh prompting for confirmation when cloning.
    if [ ! -f "$HOME"/.ssh/known_hosts ]; then
        echo "Creating $HOME/.ssh/known_hosts..."
        mkdir -p "$HOME"/.ssh
        touch "$HOME"/.ssh/known_hosts
        chmod 600 "$HOME"/.ssh/known_hosts
        echo
    fi
    if ! ssh-keygen -F github.com >/dev/null; then
        echo "Adding github.com to known hosts..."
        ssh-keyscan github.com >>"$HOME"/.ssh/known_hosts
        echo
    fi
fi

git clone --bare "$REPO_URL" "$REPO_DIR"
echo

dot config status.showUntrackedFiles no
dot config remote.origin.fetch '+refs/heads/*:refs/remotes/origin/*'
dot config branch.main.remote origin
dot config branch.main.merge refs/heads/main

if [ -n "$(dot status --porcelain)" ]; then
    stash_name="bootstrap-$(date +%s)"
    user=$(whoami)
    echo "Stashing conflicts in $stash_name..."
    dot -c user.name="$user" -c user.email="$user"@localhost stash push -m "$stash_name"
    echo
fi

echo "All done! Restart your shell to apply changes."
